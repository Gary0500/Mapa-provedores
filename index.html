<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa Proveedores – Reparado</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100vw; }
    .panel {
      position: absolute; top: 10px; left: 10px;
      background: #fff; padding: 15px;
      border-radius: 10px; width: 300px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      z-index: 9999;
    }
    .provider-list li { cursor:pointer; padding:5px; }
    .dark-mode { background: #111; color: #eee; }
    .dark-mode .panel { background:#1e1e1e; }
  </style>
</head>
<body>

<div class="panel">
  <h2>Rutas Inteligentes</h2>

  <label><input type="checkbox" id="darkModeToggle"> Modo oscuro</label><br><br>

  <h3>Proveedores</h3>
  <ul class="provider-list" id="listaProveedores"></ul>

  <h3>Ruta</h3>
  <p><b>Inicio:</b> <span id="inicioTxt">—</span></p>
  <p><b>Destino:</b> <span id="destinoTxt">—</span></p>
  <p><b>Distancia:</b> <span id="distanciaTxt">0 km</span></p>
  <p><b>Tiempo:</b> <span id="tiempoTxt">0 min</span></p>
  <p><b>Combustible:</b> <span id="combTxt">0 MXN</span></p>

  <button id="simBtn">Simular viaje</button>
  <button id="openGM">Abrir en Google Maps</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
function toggleDarkMode(){ document.body.classList.toggle('dark-mode'); }

const map = L.map('map').setView([19.43, -99.13], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let inicio = null;
let destino = null;
let rutaLinea = null;
let marcador = null;
let rutaCoords = [];

const proveedores = [
  { nombre:"Cancún 1", lat:21.1619, lng:-86.8515 },
  { nombre:"Veracruz 1", lat:19.1738, lng:-96.1342 },
  { nombre:"Tlaxcala 1", lat:19.3139, lng:-98.2416 }
];

// Mostrar proveedores
const lista = document.getElementById("listaProveedores");
proveedores.forEach(p=>{
  const li=document.createElement("li");
  li.textContent=p.nombre;
  li.onclick=()=>{
    destino = L.latLng(p.lat,p.lng);
    document.getElementById('destinoTxt').textContent = `${p.lat}, ${p.lng}`;
    calcularRuta();
  }
  lista.appendChild(li);
});

proveedores.forEach(p=> L.marker([p.lat,p.lng]).addTo(map).bindPopup(p.nombre));

map.on('contextmenu', e=>{
  inicio = e.latlng;
  document.getElementById('inicioTxt').textContent = `${inicio.lat.toFixed(4)}, ${inicio.lng.toFixed(4)}`;
  calcularRuta();
});

map.on('click', e=>{
  destino = e.latlng;
  document.getElementById('destinoTxt').textContent = `${destino.lat.toFixed(4)}, ${destino.lng.toFixed(4)}`;
  calcularRuta();
});

async function calcularRuta(){
  if(!inicio || !destino) return;

  const url = `https://router.project-osrm.org/route/v1/driving/${inicio.lng},${inicio.lat};${destino.lng},${destino.lat}?overview=full&geometries=geojson`;
  const r = await fetch(url);
  const data = await r.json();
  if(!data.routes || !data.routes.length) return;

  const ruta = data.routes[0];
  rutaCoords = ruta.geometry.coordinates;

  const km = ruta.distance/1000;
  const min = ruta.duration/60;
  const costo = (km/12)*23;

  document.getElementById('distanciaTxt').textContent = km.toFixed(2)+" km";
  document.getElementById('tiempoTxt').textContent = min.toFixed(1)+" min";
  document.getElementById('combTxt').textContent = costo.toFixed(2)+" MXN";

  if(rutaLinea) map.removeLayer(rutaLinea);

  const puntos = rutaCoords.map(c=>[c[1],c[0]]);
  rutaLinea = L.polyline(puntos,{color:'blue'}).addTo(map);
  map.fitBounds(puntos);
}

function iniciarSimulacion(){
  if(!rutaCoords.length) return alert("Genera una ruta primero.");
  if(marcador) map.removeLayer(marcador);
  const [lng,lat] = rutaCoords[0];
  marcador = L.marker([lat,lng]).addTo(map);
}

function abrirGoogleMaps(){
  if(!inicio || !destino) return alert("Selecciona inicio y destino.");
  window.open(`https://www.google.com/maps/dir/${inicio.lat},${inicio.lng}/${destino.lat},${destino.lng}`);
}

document.getElementById('darkModeToggle').onclick = toggleDarkMode;
document.getElementById('simBtn').onclick = iniciarSimulacion;
document.getElementById('openGM').onclick = abrirGoogleMaps;
</script>

</body>
</html>
